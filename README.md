# `tg` - Генератор сервисов для Go

`tg` — это инструмент для автоматизации создания сервисов на языке Go. Он избавляет разработчиков от рутинных
задач, связанных с настройкой инфраструктуры, позволяя сосредоточиться на реализации бизнес-логики. В этом документе мы
подробно рассмотрим возможности `tg`, его структуру, процесс настройки и использования, а также аннотации для
кастомизации поведения.

## Оглавление

1. [Цель и возможности](#цель-и-возможности)
2. [Основные компоненты сервиса](#основные-компоненты-сервиса)
3. [Инициализация проекта](#инициализация-проекта)
4. [Описание контракта](#описание-контракта)
5. [Генерация сервера](#генерация-сервера)
    - [Генерация транспортного слоя](#генерация-транспортного-слоя)
    - [Генерация документации](#генерация-документации)
    - [Инициализация сервера](#инициализация-сервера)
    - [Опции сервера](#опции-сервера)
6. [Генерация клиента](#генерация-клиента)
    - [Генерация кода клиента](#генерация-кода-клиента)
    - [Инициализация клиента](#инициализация-клиента)
    - [Опции клиента](#опции-клиента)
7. [Аннотации](#аннотации)
    - [Общий формат](#общий-формат)
    - [Уровни применения](#уровни-применения)
    - [Список аннотаций](#список-аннотаций)
8. [Метрики](#метрики)
9. [Заключение](#заключение)

## Цель и возможности

`tg` (Transport Generator) создан для упрощения разработки сервисов на Go. Он автоматизирует создание инфраструктурных
компонентов, таких как транспортный слой, логирование, метрики, трассировка и клиентская часть, позволяя разработчикам
сосредоточиться на реализации бизнес-логики. Основные преимущества:

- **Автоматизация рутины**: Генерация кода для логирования, метрик, трассировки и транспорта.
- **Гибкость**: Поддержка JSON-RPC 2.0 и HTTP-транспорта на базе высокопроизводительного
  фреймворка [go-fiber](https://docs.gofiber.io).
- **Простота интеграции**: Генерация клиентов для Go и JavaScript.
- **Документация**: Автоматическая генерация OpenAPI-документации.

`tg` использует интерфейсы Go с аннотациями в качестве источника истины, что делает процесс описания контракта
интуитивно понятным и прозрачным.

## Основные компоненты сервиса

Разработка сервиса с использованием `tg` включает следующие ключевые аспекты:

1. **Описание контракта**: Определение интерфейса сервиса на Go с аннотациями.
2. **Реализация бизнес-логики**: Основная задача разработчика — написать логику методов.
3. **Логирование запросов**: Автоматическая генерация логов для всех запросов.
4. **Метрики сервиса**: Сбор статистики производительности и использования.
5. **Трассировка запросов**: Отслеживание выполнения запросов для диагностики.
6. **Транспортный слой**: Поддержка JSON-RPC 2.0 и HTTP на базе [go-fiber](https://docs.gofiber.io).
7. **Клиент для интеграции**: Генерация клиентов для удобного взаимодействия с сервисом.

`tg` автоматизирует всё, кроме реализации бизнес-логики, что значительно ускоряет и упрощает разработку.

## Инициализация проекта

Для создания нового проекта с нуля можно использовать команду `init`, которая генерирует шаблон сервиса:

```bash
tg init -module <go-module-name> -service <service-name> <project-name>
```

- **`-module`**: Имя Go-модуля (например, `github.com/example/myservice`).
- **`-service`**: Имя сервиса.
- **`<project-name>`**: Имя директории, в которой будет создан проект.

Пример:

```bash
tg init -module github.com/example/myservice -service MyService myservice
```

Эта команда создаст в папке `myservice` готовый шаблон проекта, включающий структуру директорий и базовые файлы для
дальнейшей работы.

> **Примечание**: Использование шаблона не обязательно. Вы можете начать с описания интерфейса в существующем проекте.

## Описание контракта

Контракт сервиса описывается в виде интерфейса на Go с использованием аннотаций `tg`. Интерфейс определяет публичные
методы сервиса, а аннотации задают настройки для генерации.

### Требования к интерфейсу

1. **Именованные аргументы и возвращаемые значения**: Все параметры методов и возвращаемые значения (кроме `error`)
   должны быть именованными. Эти имена используются в транспортном слое (например, в JSON-RPC).
2. **Контекст и ошибка**: Первый аргумент метода — `context.Context`, последний возвращаемый тип — `error`.

Пример интерфейса:

```go
// @tg jsonRPC-server log metrics trace
type SomeService interface {
Method(ctx context.Context, arg1 string, arg2 int) (ret1 int, ret2 float64, err error)
}
```

Этот интерфейс описывает метод `Method`, который принимает `arg1` (строка) и `arg2` (целое число), возвращает `ret1` (
целое число), `ret2` (число с плавающей точкой) и `err` (ошибку). Аннотации включают поддержку JSON-RPC, логирование,
метрики и трассировку.

### Пример JSON-RPC запроса и ответа

Для метода `SomeService.Method` запрос в формате JSON-RPC 2.0 будет выглядеть так:

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "someService.method",
  "params": {
    "arg1": "example",
    "arg2": 42
  }
}
```

Ответ:

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": {
    "ret1": 100,
    "ret2": 3.14
  }
}
```

## Генерация сервера

### Генерация транспортного слоя

Для создания транспортного слоя выполните команду:

```bash
tg transport --services . --out ../internal/transport
```

- **`--services`**: Путь к директории с интерфейсами (обычно текущая папка).
- **`--out`**: Путь для сохранения сгенерированного кода.

После генерации рекомендуется использовать `goimports` для форматирования:

```bash
goimports -l -w ../internal/transport
```

### Генерация документации

Для создания документации в формате OpenAPI выполните:

```bash
tg swagger --services . --outFile ../api/swagger.yaml
```

- **`--services`**: Путь к директории с интерфейсами.
- **`--outFile`**: Путь для сохранения файла `swagger.yaml`.

### Инициализация сервера

Для запуска сервера необходимо указать сервисы (интерфейсы) и настроить опции. Пример:

```go
...

svcSome := some.New()

options := []transport.Option{
transport.Use(cors.New()),
transport.WithRequestID("X-Request-Id"),
transport.Some(transport.NewSome(svcSome)),
}

srv := transport.New(log.Logger, options...).WithMetrics().WithLog()

srv.ServeHealth(config.Service().HealthBind, "OK")
srv.ServeMetrics(log.Logger, "/", config.Service().MetricsBind)

go func () {
log.Info().Str("bind", config.Service().Bind).Msg("listen on")
if err := srv.Fiber().Listen(config.Service().Bind); err != nil {
log.Panic().Err(err).Msg("server error")
}  
}()

...
```

В этом примере сервер запускается с поддержкой CORS, уникальным идентификатором запроса и метриками. Метод `ServeHealth`
предоставляет эндпоинт для проверки состояния, а `ServeMetrics` — для сбора метрик.

### Опции сервера

`tg` поддерживает множество опций для настройки сервера:

- **`SetFiberCfg(cfg fiber.Config)`**: Настройка конфигурации go-fiber (например, включение Prefork или установка имени
  приложения).
- **`SetReadBufferSize(size int)`**: Установка размера буфера чтения (по умолчанию 4096 байт).
- **`SetWriteBufferSize(size int)`**: Установка размера буфера записи (по умолчанию 4096 байт).
- **`MaxBodySize(max int)`**: Ограничение размера тела запроса (по умолчанию 4 МБ).
- **`MaxBatchSize(size int)`**: Максимальное количество запросов в JSON-RPC батче (по умолчанию 100).
- **`MaxBatchWorkers(size int)`**: Количество параллельных обработчиков батч-запросов (по умолчанию 10).
- **`ReadTimeout(timeout time.Duration)`**: Таймаут чтения запросов (по умолчанию не ограничен).
- **`WriteTimeout(timeout time.Duration)`**: Таймаут записи ответа (по умолчанию не ограничен).
- **`WithRequestID(headerName string)`**: Указание заголовка для идентификатора запроса (логируется и передаётся в
  ответ).

## Генерация клиента

### Генерация кода клиента

Для создания Go-клиента:

```bash
tg client -go --services . --outPath ../pkg/clients/go
```

Для создания JavaScript-клиента:

```bash
tg client -js --services . --outPath ../pkg/clients/js --outPackage ../
```

- **`--services`**: Путь к директории с интерфейсами.
- **`--outPath`**: Путь для сохранения сгенерированного кода.
- **`--outPackage`**: Путь для сохранения `package.json` (для JS-клиента).

После генерации используйте `goimports` для Go-клиента:

```bash
goimports -l -w ../pkg/clients/go
```

### Инициализация клиента

Пример инициализации Go-клиента:

```go
package main

import (
	"github.com/example/myservice/pkg/clients/go/some"
)

func main() {
	cli := some.New("http://127.0.0.1:9000")
	someCli := cli.Some()

	// Вызов метода
	ret1, ret2, err := someCli.Method(context.Background(), "example", 42)
	if err != nil {
		log.Fatal(err)
	}
	fmt.Printf("ret1: %d, ret2: %f\n", ret1, ret2)
}
```

### Опции клиента

- **`DecodeError(decoder ErrorDecoder)`**: Указание декодера ошибок.
- **`LogRequest()`**: Включение логирования всех запросов в формате curl.
- **`LogOnError()`**: Логирование запросов только при ошибках.
- **`Headers(headers ...any)`**: Передача заголовков из контекста запроса.
- **`ConfigTLS(tlsConfig *tls.Config)`**: Настройка TLS (например, для самоподписанных сертификатов).
- **`CircuitBreaker(cfg cb.Settings)`**: Настройка circuit breaker для устойчивости.
- **`Cache(cache cache)`**: Включение кэширования для circuit breaker.
- **`FallbackTTL(ttl time.Duration)`**: Время жизни кэшированного ответа (по умолчанию 24 часа).

## Аннотации

Аннотации позволяют настраивать поведение генерации кода. Они задаются в виде комментариев Go с префиксом `@tg`.
В одной строке может быть одна или несколько аннотаций, разделённых пробелами.

### Общий формат

```go
// @tg <имя>=<значение> [другие аннотации]
```

Пример:

```go
// @tg http-prefix=v1 jsonRPC-server log metrics trace
```

Эквивалентная запись:

```go
// @tg http-prefix=v1
// @tg jsonRPC-server
// @tg log metrics trace
```

### Уровни применения

- **Пакет**: Действует на все интерфейсы и методы в пакете.
- **Интерфейс**: Действует на все методы интерфейса.
- **Метод**: Действует только на конкретный метод.
- **Тип**: Применяется к полям структур.

Приоритет: пакет > интерфейс > метод

### Список аннотаций

| Аннотация                                | Уровень                      | Описание                                                                 |
|------------------------------------------|------------------------------|--------------------------------------------------------------------------|
| `log`                                    | Пакет, интерфейс             | Включает логирование запросов.                                           |
| `trace`                                  | Пакет, интерфейс             | Включает трассировку запросов.                                           |
| `metrics`                                | Пакет, интерфейс             | Включает сбор метрик.                                                    |
| `desc=<описание>`                        | Пакет, интерфейс, метод, тип | Краткое описание для документации OpenAPI.                               |
| `summary=<описание>`                     | Метод                        | Детальное описание метода для OpenAPI. Поддерживает форматирование.      |
| `<переменная>.tags=<тег>:<значение>`     | Метод                        | Настройка тегов для полей (например, `dumper:hide` для скрытия в логах). |
| `type=<тип>`                             | Тип                          | Указание типа поля в документации OpenAPI.                               |
| `enums=val1,val2`                        | Тип                          | Список возможных значений поля.                                          |
| `format=uuid`                            | Тип                          | Формат поля в документации OpenAPI (например, `uuid`).                   |
| `required`                               | Тип                          | Указывает, что поле обязательно.                                         |
| `example=<значение>`                     | Тип                          | Пример значения поля в документации.                                     |
| `http-args=<переменная>\|<ключ>`         | Метод                        | Маппинг параметров URL на аргументы метода.                              |
| `http-path=/<путь>/:<переменная>`        | Метод                        | Маппинг пути URL на аргументы метода.                                    |
| `http-prefix=<префикс>`                  | Пакет, интерфейс             | Префикс пути URL для методов.                                            |
| `http-headers=<переменная>\|<заголовок>` | Метод                        | Маппинг заголовков на аргументы/результаты.                              |
| `http-cookies=<переменная>\|<cookie>`    | Метод                        | Маппинг cookies на аргументы/результаты.                                 |
| `http-method=<метод>`                    | Метод                        | HTTP-метод для доступа к методу (например, `GET`, `POST`).               |
| `http-success=<код>`                     | Метод                        | HTTP-код успешного ответа (например, `200`).                             |
| `packageJSON=<пакет>`                    | Пакет                        | Переопределение JSON-кодека (например, `github.com/seniorGolang/json`).  |
| `uuidPackage=<пакет>`                    | Пакет                        | Переопределение пакета для UUID (по умолчанию `github.com/google/uuid`). |
| `swaggerTags=<тег1,тег2>`                | Интерфейс                    | Теги для группировки в OpenAPI.                                          |
| `log-skip=<переменная>`                  | Метод                        | Исключение переменных из логов.                                          |
| `deprecated`                             | Метод                        | Пометка метода как устаревшего в OpenAPI.                                |
| `tagNoOmitempty`                         | Интерфейс                    | Отключение тега `omitempty` для полей ответа.                            |
| `http-response=<модуль>:<метод>`         | Метод                        | Указание кастомного обработчика с контекстом go-fiber.                   |
| `handler=<модуль>:<метод>`               | Метод                        | Указание полностью кастомного обработчика.                               |
| `requestContentType=<mime>`              | Метод                        | MIME-тип запроса (по умолчанию `application/json`).                      |
| `responseContentType=<mime>`             | Метод                        | MIME-тип ответа (по умолчанию `application/json`).                       |
| `security=bearer`                        | Пакет                        | Указание авторизации для OpenAPI.                                        |
| `servers=<адрес>;<имя>`                  | Пакет                        | Список серверов для документации OpenAPI.                                |
| `version=<версия>`                       | Пакет                        | Версия сервиса для документации.                                         |
| `title=<заголовок>`                      | Пакет                        | Заголовок документации OpenAPI.                                          |
| `author=<автор>`                         | Пакет                        | Автор NPM-пакета.                                                        |
| `npmRegistry=<адрес>`                    | Пакет                        | Адрес NPM-репозитория.                                                   |
| `npmName=<имя>`                          | Пакет                        | Имя NPM-пакета.                                                          |
| `npmPrivate=<true\|false>`               | Пакет                        | Приватность NPM-пакета.                                                  |
| `license=<лицензия>`                     | Пакет                        | Лицензия NPM-пакета.                                                     |
| `http-server`                            | Интерфейс                    | Включение HTTP-сервера.                                                  |
| `jsonRPC-server`                         | Интерфейс                    | Включение JSON-RPC 2.0 сервера.                                          |
| `enableInlineSingle`                     | Метод                        | Включение inline для методов с единственным возвращаемым значением.      |

## Метрики

`tg` автоматически генерирует метрики для мониторинга производительности сервиса. Доступные метрики:

- **`RequestCount`**: Счётчик запросов с метками `method`, `service`, `success`.
  ```go
  RequestCount = prometheus.NewCounterFrom(prometheus.CounterOpts{
      Help:      "Number of requests received",
      Name:      "count",
      Namespace: "service",
      Subsystem: "requests",
  }, []string{"method", "service", "success"})
  ```

- **`RequestCountAll`**: Счётчик всех запросов с метками `method`, `service`.
  ```go
  RequestCountAll = prometheus.NewCounterFrom(prometheus.CounterOpts{
      Help:      "Number of all requests received",
      Name:      "all_count",
      Namespace: "service",
      Subsystem: "requests",
  }, []string{"method", "service"})
  ```

- **`RequestLatency`**: Гистограмма времени выполнения запросов в микросекундах.
  ```go
  RequestLatency = prometheus.NewHistogramFrom(prometheus.HistogramOpts{
      Help:      "Total duration of requests in microseconds",
      Name:      "latency_microseconds",
      Namespace: "service",
      Subsystem: "requests",
  }, []string{"method", "service", "success"})
  ```

## Заключение

`tg` — это инструмент, который упрощает разработку сервисов на Go, автоматизируя рутинные задачи и предоставляя
гибкие возможности для настройки. С его помощью вы можете быстро создавать высокопроизводительные сервисы с поддержкой
JSON-RPC, HTTP, логирования, метрик и трассировки, а также генерировать клиентов для удобной интеграции.

Для начала работы достаточно описать интерфейс, добавить аннотации и сгенерировать код. Попробуйте `tg` в своём
следующем проекте и оцените, насколько он ускоряет разработку!

Если вы хотите улучшить функциональность, добавить новые возможности или исправить ошибки, внесите свой вклад в проект.
Посетите наш репозиторий на GitHub (замените на актуальную ссылку), чтобы отправить pull request, сообщить о проблеме
или предложить идею.